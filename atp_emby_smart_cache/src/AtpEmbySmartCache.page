Menu="Utilities"
Title="ATP Emby Smart Cache"
Icon="bolt"
---
<?php
// MUST be first - suppress ALL errors before anything else runs
error_reporting(0);
ini_set('display_errors', 0);

$plugin = "atp_emby_smart_cache";
$version = "v2026.01.29a";
$configFile = "/boot/config/plugins/{$plugin}/settings.json";
$dataDir = "/mnt/user/appdata/atp_emby_smart_cache";

// CSRF token for Unraid 7 security
$csrf_token = $var['csrf_token'] ?? '';

$defaults = [
    "ENABLED" => false,  // Disabled until configured
    "EMBY_HOST" => "",   // User must configure
    "EMBY_API_KEY" => "",
    "DISCORD_WEBHOOK_URL" => "",
    "SERVER_PORT" => 9999,
    "UNRAID_USER_PATH" => "/mnt/user",
    "CACHE_PATH" => "/mnt/cache",
    "ARRAY_ONLY_PATH" => "/mnt/user0",
    "LOG_FILE_PATH" => "/mnt/user/appdata/atp_emby_smart_cache/logs/atp_emby_smart_cache.log",
    "RSYNC_BWLIMIT" => "0",
    "MIN_FREE_SPACE_GB" => 100,
    "MAX_FILE_SIZE_GB" => 0,
    "SKIP_HARDLINKS" => true,
    "DELETE_ON_STOP" => true,
    "CLEANUP_DELAY_HOURS" => 24,
    "MOVER_IGNORE_FILE" => "",
    "ALLOWED_EXTS" => ".mkv,.mp4,.m4v,.avi,.mov,.ts",
    "EXCLUDE_PATHS" => "",
    "DOCKER_PATH_MAP" => "",
    "COOLDOWN_MOVIE_SEC" => 60,
    "COOLDOWN_EPISODE_SEC" => 30,
    "PRECACHE_EPISODES" => 1,
    "RSYNC_RETRIES" => 3,
    "LOG_RETENTION" => 5,
    "LOG_LEVEL" => "INFO"
];

$settings = $defaults;
if (file_exists($configFile)) {
    $loaded = json_decode(file_get_contents($configFile), true);
    if ($loaded) $settings = array_merge($defaults, $loaded);
}

// Get PID from PIDFILE (more reliable than pgrep which can match multiple processes)
$pidFile = "/var/run/{$plugin}.pid";
$pid = '';
$running = false;
if (file_exists($pidFile)) {
    $pid = trim(file_get_contents($pidFile));
    // Verify process is actually running
    if (!empty($pid) && file_exists("/proc/{$pid}")) {
        $running = true;
    } else {
        $pid = ''; // Stale PID file
    }
}

function apiCall($endpoint, $method = 'GET', $data = null) {
    global $settings;
    $port = isset($settings['SERVER_PORT']) ? intval($settings['SERVER_PORT']) : 9999;
    $url = "http://127.0.0.1:{$port}{$endpoint}";
    
    // Try curl first
    if (function_exists('curl_init')) {
        $ch = curl_init($url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_TIMEOUT, 5);
        curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 3);
        curl_setopt($ch, CURLOPT_FOLLOWLOCATION, false);
        if ($method === 'POST' && $data !== null) {
            curl_setopt($ch, CURLOPT_POST, true);
            curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
            curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
        }
        $resp = curl_exec($ch);
        $code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        $err = curl_error($ch);
        $errno = curl_errno($ch);
        curl_close($ch);
        
        if (!$err && $resp !== false && $code >= 200 && $code < 300) {
            $decoded = json_decode($resp, true);
            if ($decoded !== null) return $decoded;
        }
        // Log curl error for debugging
        $curlError = $err ?: "HTTP {$code}, errno {$errno}";
    } else {
        $curlError = "curl not available";
    }
    
    // Fallback to file_get_contents with stream context
    $context = stream_context_create([
        'http' => [
            'method' => $method,
            'header' => "Content-Type: application/json\r\n",
            'content' => ($method === 'POST' && $data) ? json_encode($data) : '',
            'timeout' => 5,
            'ignore_errors' => true
        ]
    ]);
    
    $resp = @file_get_contents($url, false, $context);
    if ($resp !== false) {
        $decoded = json_decode($resp, true);
        if ($decoded !== null) return $decoded;
    }
    
    return ['success' => false, 'error' => "API unavailable ({$curlError})", 'url' => $url];
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['ajax'])) {
    header('Content-Type: application/json');
    $action = $_POST['ajax'];
    
    // Raw test to see what PHP actually outputs
    if ($action === 'raw_test') {
        die(json_encode(['success' => true, 'test' => 'OK', 'pid' => $pid, 'running' => $running]));
    }
    
    if ($action === 'get_status') {
        $result = apiCall('/api/status');
        // If API call failed but PID exists, show offline status
        if (!$result['success'] && $running) {
            $result = [
                'success' => true,
                'data' => [
                    'running' => false,
                    'uptime' => 0,
                    'active' => [],
                    'active_count' => 0,
                    'queue_count' => 0,
                    'managed_count' => 0,
                    'total_gb' => 0,
                    'api_error' => $result['error'] ?? 'API not responding'
                ]
            ];
        }
        echo json_encode($result);
    } elseif ($action === 'get_managed') {
        echo json_encode(apiCall('/api/managed'));
    } elseif ($action === 'get_queue') {
        echo json_encode(apiCall('/api/queue'));
    } elseif ($action === 'get_logs') {
        $lines = isset($_POST['lines']) ? intval($_POST['lines']) : 100;
        $result = apiCall("/api/logs?lines={$lines}");
        // Fallback: read log file directly if API fails
        if (!$result['success']) {
            $logPath = $settings['LOG_FILE_PATH'];
            if (is_dir($logPath)) $logPath = rtrim($logPath, '/') . "/atp_emby_smart_cache.log";
            if (file_exists($logPath)) {
                $logLines = file($logPath, FILE_IGNORE_NEW_LINES);
                $logLines = array_slice($logLines, -$lines);
                $result = ['success' => true, 'logs' => implode("\n", $logLines) . "\n[Read directly - API offline]"];
            }
        }
        echo json_encode($result);
    } elseif ($action === 'get_mover') {
        $result = apiCall('/api/mover_ignore');
        // Fallback: read mover ignore file directly if API fails
        if (!$result['success']) {
            $moverFile = $settings['MOVER_IGNORE_FILE'];
            if (!empty($moverFile) && file_exists($moverFile)) {
                $result = ['success' => true, 'content' => file_get_contents($moverFile) . "\n[Read directly - API offline]"];
            } else {
                $result = ['success' => true, 'content' => '(empty or not configured)'];
            }
        }
        echo json_encode($result);
    } elseif ($action === 'get_history') {
        echo json_encode(apiCall('/api/history'));
    } elseif ($action === 'force_cleanup') {
        $path = isset($_POST['path']) ? $_POST['path'] : '';
        echo json_encode(apiCall('/api/cleanup', 'POST', ['path' => $path]));
    } elseif ($action === 'rebuild_state') {
        echo json_encode(apiCall('/api/rebuild', 'POST', []));
    } elseif ($action === 'clear_log') {
        $logPath = $settings['LOG_FILE_PATH'];
        if (is_dir($logPath)) $logPath = rtrim($logPath, '/') . "/atp_emby_smart_cache.log";
        file_put_contents($logPath, "");
        echo json_encode(['success' => true, 'message' => 'Log cleared']);
    } elseif ($action === 'debug_api') {
        // Debug endpoint to test API connectivity
        $port = isset($settings['SERVER_PORT']) ? intval($settings['SERVER_PORT']) : 9999;
        $url = "http://127.0.0.1:{$port}/api/status";
        $debug = [
            'port' => $port,
            'url' => $url,
            'curl_available' => function_exists('curl_init'),
            'allow_url_fopen' => ini_get('allow_url_fopen')
        ];
        
        // Test curl
        if (function_exists('curl_init')) {
            $ch = curl_init($url);
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
            curl_setopt($ch, CURLOPT_TIMEOUT, 3);
            $resp = curl_exec($ch);
            $debug['curl_response'] = substr($resp ?: '', 0, 200);
            $debug['curl_error'] = curl_error($ch);
            $debug['curl_errno'] = curl_errno($ch);
            $debug['curl_http_code'] = curl_getinfo($ch, CURLINFO_HTTP_CODE);
            curl_close($ch);
        }
        
        // Test file_get_contents
        $ctx = stream_context_create(['http' => ['timeout' => 3]]);
        $resp2 = @file_get_contents($url, false, $ctx);
        $debug['fgc_response'] = substr($resp2 ?: '', 0, 200);
        $debug['fgc_error'] = $resp2 === false ? error_get_last()['message'] ?? 'unknown' : 'none';
        
        echo json_encode(['success' => true, 'debug' => $debug]);
    } elseif ($action === 'save_settings') {
        ob_start(); // Capture any stray output
        $new = $defaults;
        foreach ($defaults as $k => $v) {
            if (isset($_POST[$k])) {
                if (is_bool($v) || in_array($k, ['ENABLED','SKIP_HARDLINKS','DELETE_ON_STOP'])) {
                    $new[$k] = ($_POST[$k] === 'true' || $_POST[$k] === '1');
                } else {
                    $new[$k] = trim($_POST[$k]);
                }
            }
        }
        $saved = file_put_contents($configFile, json_encode($new, JSON_PRETTY_PRINT));
        $out = [];
        exec("/usr/local/emhttp/plugins/{$plugin}/rc.atp_emby_smart_cache restart 2>&1", $out, $ret);
        ob_end_clean(); // Discard any stray output
        $msg = $saved !== false ? 'Settings saved' : 'Failed to save settings';
        if (!empty($out)) $msg .= ', restart: ' . implode(' ', $out);
        echo json_encode(['success' => $saved !== false, 'message' => $msg]);
    }
    exit;
}

// Get PID from PIDFILE for page rendering
$pidFile = "/var/run/{$plugin}.pid";
$pid = '';
$running = false;
if (file_exists($pidFile)) {
    $pid = trim(file_get_contents($pidFile));
    if (!empty($pid) && file_exists("/proc/{$pid}")) {
        $running = true;
    } else {
        $pid = '';
    }
}
?>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root {
    --esc-primary: #e67e22;
    --esc-primary-dark: #d35400;
    --esc-success: #27ae60;
    --esc-warning: #f39c12;
    --esc-danger: #c0392b;
    --esc-info: #3498db;
    --esc-bg-dark: #1a1a1a;
    --esc-bg-card: #252525;
    --esc-border: #333;
    --esc-text: #e0e0e0;
    --esc-text-muted: #888;
}
.esc-container { max-width: 1400px; margin: 0 auto; }
.esc-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 2px solid var(--esc-primary); margin-bottom: 20px; }
.esc-header h1 { margin: 0; font-size: 24px; color: var(--esc-primary); }
.esc-header h1 i { margin-right: 10px; }
.esc-status-badge { padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: bold; }
.esc-status-badge.running { background: var(--esc-success); color: #fff; }
.esc-status-badge.stopped { background: var(--esc-danger); color: #fff; }
.esc-tabs { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 1px solid var(--esc-border); padding-bottom: 10px; }
.esc-tab { padding: 10px 20px; background: var(--esc-bg-card); border: 1px solid var(--esc-border); border-radius: 5px 5px 0 0; cursor: pointer; color: var(--esc-text-muted); transition: all 0.2s; }
.esc-tab:hover { background: #333; color: var(--esc-text); }
.esc-tab.active { background: var(--esc-primary); color: #fff; border-color: var(--esc-primary); }
.esc-tab i { margin-right: 8px; }
.esc-panel { display: none; }
.esc-panel.active { display: block; }
.esc-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
.esc-card { background: var(--esc-bg-card); border: 1px solid var(--esc-border); border-radius: 8px; padding: 20px; }
.esc-card-header { font-size: 12px; text-transform: uppercase; color: var(--esc-text-muted); margin-bottom: 8px; }
.esc-card-value { font-size: 28px; font-weight: bold; color: var(--esc-text); }
.esc-card-value.success { color: var(--esc-success); }
.esc-card-value.warning { color: var(--esc-warning); }
.esc-card-value.danger { color: var(--esc-danger); }
.esc-card-icon { float: right; font-size: 32px; opacity: 0.3; margin-top: -10px; }
.esc-table { width: 100%; border-collapse: collapse; background: var(--esc-bg-card); border-radius: 8px; overflow: hidden; }
.esc-table th, .esc-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--esc-border); }
.esc-table th { background: #333; color: var(--esc-primary); font-weight: 600; text-transform: uppercase; font-size: 11px; }
.esc-table tr:hover { background: #2a2a2a; }
.esc-table .filename { max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.esc-btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; transition: all 0.2s; }
.esc-btn-primary { background: var(--esc-primary); color: #fff; }
.esc-btn-primary:hover { background: #e07b00; }
.esc-btn-danger { background: var(--esc-danger); color: #fff; }
.esc-btn-danger:hover { background: #d32f2f; }
.esc-btn-small { padding: 4px 10px; font-size: 11px; }
.esc-log-box { background: #111; color: #0f0; font-family: 'Courier New', monospace; font-size: 12px; padding: 15px; border-radius: 8px; height: 400px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; user-select: text; -webkit-user-select: text; -moz-user-select: text; cursor: text; }
.esc-form-group { margin-bottom: 15px; }
.esc-form-group label { display: block; margin-bottom: 5px; color: var(--esc-text); font-weight: 500; }
.esc-form-group input, .esc-form-group select { padding: 8px 12px; border: 1px solid var(--esc-border); border-radius: 4px; background: #222; color: var(--esc-text); }
.esc-form-group input[type="text"], .esc-form-group input[type="number"] { width: 300px; }
.esc-form-group .help { font-size: 11px; color: var(--esc-text-muted); margin-top: 3px; }
.esc-section { background: var(--esc-bg-card); border: 1px solid var(--esc-border); border-radius: 8px; padding: 20px; margin-bottom: 20px; }
.esc-section-title { color: var(--esc-primary); font-size: 14px; font-weight: bold; text-transform: uppercase; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--esc-border); }
.esc-activity { max-height: 300px; overflow-y: auto; }
.esc-activity-item { padding: 10px; border-bottom: 1px solid var(--esc-border); display: flex; align-items: center; gap: 10px; }
.esc-activity-item:last-child { border-bottom: none; }
.esc-activity-icon { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
.esc-activity-icon.copy { background: var(--esc-info); }
.esc-activity-icon.cleanup { background: var(--esc-warning); }
.esc-activity-icon.error { background: var(--esc-danger); }
.esc-spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid #333; border-top-color: var(--esc-primary); border-radius: 50%; animation: esc-spin 1s linear infinite; }
@keyframes esc-spin { to { transform: rotate(360deg); } }
.esc-countdown { font-family: monospace; color: var(--esc-warning); }
.esc-refresh-indicator { font-size: 11px; color: var(--esc-text-muted); }
.esc-toolbar { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }

/* Health indicators */
.esc-health-item { display: flex; flex-direction: column; gap: 5px; }
.esc-health-label { font-size: 12px; color: var(--esc-text-muted); text-transform: uppercase; }
.esc-health-value { font-size: 14px; color: var(--esc-text); font-weight: 500; }
.esc-progress-bar { height: 8px; background: #333; border-radius: 4px; overflow: hidden; flex-grow: 1; min-width: 100px; }
.esc-progress-fill { height: 100%; background: var(--esc-success); transition: width 0.3s, background 0.3s; }
.esc-progress-fill.warning { background: var(--esc-warning); }
.esc-progress-fill.danger { background: var(--esc-danger); }

/* Mobile responsive - only affects small screens */
@media (max-width: 768px) {
    .esc-tabs { flex-wrap: wrap; gap: 3px; }
    .esc-tab { padding: 8px 12px; font-size: 12px; flex: 1 1 auto; text-align: center; min-width: 80px; }
    .esc-tab i { margin-right: 5px; display: none; }
    .esc-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .esc-card { padding: 15px; }
    .esc-card-value { font-size: 22px; }
    .esc-card-icon { font-size: 24px; }
    .esc-table { font-size: 12px; }
    .esc-table th, .esc-table td { padding: 8px 10px; }
    .esc-table .filename { max-width: 150px; }
    .esc-header { flex-direction: column; gap: 10px; text-align: center; }
    .esc-header h1 { font-size: 20px; }
    .esc-form-group input[type="text"], .esc-form-group input[type="number"] { width: 100%; max-width: 300px; }
    .esc-section { padding: 15px; }
    .esc-toolbar { flex-wrap: wrap; }
    div[style*="grid-template-columns: 1fr 1fr"] { grid-template-columns: 1fr !important; }
}
@media (max-width: 480px) {
    .esc-tabs { gap: 2px; }
    .esc-tab { padding: 6px 8px; font-size: 11px; min-width: 60px; }
    .esc-grid { grid-template-columns: 1fr 1fr; }
    .esc-card-value { font-size: 18px; }
    .esc-log-box { height: 250px; font-size: 10px; }
}
</style>

<div class="esc-container">
    <div class="esc-header">
        <h1><i class="fa fa-bolt"></i> ATP Emby Smart Cache</h1>
        <div>
            <span class="esc-status-badge <?php echo $running ? 'running' : 'stopped'; ?>" id="statusBadge">
                <i class="fa <?php echo $running ? 'fa-check-circle' : 'fa-times-circle'; ?>"></i>
                <span id="statusText"><?php echo $running ? "Running (PID {$pid})" : "Stopped"; ?></span>
            </span>
            <span style="margin-left:15px; color:#888;"><?php echo $version; ?></span>
        </div>
    </div>

    <div class="esc-tabs">
        <div class="esc-tab active" data-tab="dashboard"><i class="fa fa-tachometer-alt"></i>Dashboard</div>
        <div class="esc-tab" data-tab="stats"><i class="fa fa-chart-bar"></i>Statistics</div>
        <div class="esc-tab" data-tab="files"><i class="fa fa-folder-open"></i>Managed Files</div>
        <div class="esc-tab" data-tab="queue"><i class="fa fa-clock"></i>Cleanup Queue</div>
        <div class="esc-tab" data-tab="logs"><i class="fa fa-terminal"></i>Logs</div>
        <div class="esc-tab" data-tab="settings"><i class="fa fa-cog"></i>Settings</div>
    </div>

    <!-- DASHBOARD PANEL -->
    <div class="esc-panel active" id="panel-dashboard">
        <div class="esc-grid">
            <div class="esc-card">
                <i class="fa fa-power-off esc-card-icon"></i>
                <div class="esc-card-header">Service Status</div>
                <div class="esc-card-value" id="dash-service">-</div>
            </div>
            <div class="esc-card">
                <i class="fa fa-clock esc-card-icon"></i>
                <div class="esc-card-header">Uptime</div>
                <div class="esc-card-value" id="dash-uptime">-</div>
            </div>
            <div class="esc-card">
                <i class="fa fa-sync esc-card-icon"></i>
                <div class="esc-card-header">Active Transfers</div>
                <div class="esc-card-value" id="dash-active">0</div>
            </div>
            <div class="esc-card">
                <i class="fa fa-hourglass-half esc-card-icon"></i>
                <div class="esc-card-header">Pending Cleanup</div>
                <div class="esc-card-value" id="dash-queue">0</div>
            </div>
            <div class="esc-card">
                <i class="fa fa-file-video esc-card-icon"></i>
                <div class="esc-card-header">Managed Files</div>
                <div class="esc-card-value" id="dash-managed">0</div>
            </div>
            <div class="esc-card">
                <i class="fa fa-database esc-card-icon"></i>
                <div class="esc-card-header">Total Cached</div>
                <div class="esc-card-value" id="dash-total">0 GB</div>
            </div>
        </div>

        <!-- System Health Section -->
        <div class="esc-section" style="margin-top:20px;">
            <div class="esc-section-title"><i class="fa fa-heartbeat"></i> System Health</div>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px;">
                <div class="esc-health-item">
                    <span class="esc-health-label">Cache Disk</span>
                    <div class="esc-progress-bar">
                        <div class="esc-progress-fill" id="health-cache-bar" style="width:0%"></div>
                    </div>
                    <span class="esc-health-value" id="health-cache-text">-</span>
                </div>
                <div class="esc-health-item">
                    <span class="esc-health-label">Array Disk</span>
                    <div class="esc-progress-bar">
                        <div class="esc-progress-fill" id="health-array-bar" style="width:0%"></div>
                    </div>
                    <span class="esc-health-value" id="health-array-text">-</span>
                </div>
                <div class="esc-health-item">
                    <span class="esc-health-label">Database Size</span>
                    <span class="esc-health-value" id="health-db-size">-</span>
                </div>
                <div class="esc-health-item">
                    <span class="esc-health-label">Log File Size</span>
                    <span class="esc-health-value" id="health-log-size">-</span>
                </div>
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px;">
            <div class="esc-section">
                <div class="esc-section-title"><i class="fa fa-bolt"></i> Active Transfers</div>
                <div id="active-transfers">
                    <p style="color:#888;">No active transfers</p>
                </div>
            </div>
            <div class="esc-section">
                <div class="esc-section-title"><i class="fa fa-history"></i> Recent Activity</div>
                <div class="esc-activity" id="recent-activity">
                    <p style="color:#888;">Loading...</p>
                </div>
            </div>
        </div>

        <div class="esc-toolbar" style="margin-top:20px;">
            <button class="esc-btn esc-btn-primary" onclick="rebuildState()"><i class="fa fa-sync"></i> Rebuild State</button>
            <button class="esc-btn" onclick="debugApi()" style="margin-left:10px;"><i class="fa fa-bug"></i> Debug API</button>
            <span class="esc-refresh-indicator">Auto-refresh: <span id="refresh-countdown">3</span>s</span>
        </div>
    </div>

    <!-- STATISTICS PANEL -->
    <div class="esc-panel" id="panel-stats">
        <div class="esc-grid">
            <div class="esc-card">
                <i class="fa fa-exchange-alt esc-card-icon"></i>
                <div class="esc-card-header">Total Moves</div>
                <div class="esc-card-value" id="stats-total-moves">0</div>
            </div>
            <div class="esc-card">
                <i class="fa fa-hdd esc-card-icon"></i>
                <div class="esc-card-header">Total GB Moved</div>
                <div class="esc-card-value" id="stats-total-gb">0 GB</div>
            </div>
            <div class="esc-card">
                <i class="fa fa-calendar esc-card-icon"></i>
                <div class="esc-card-header">Last Move</div>
                <div class="esc-card-value" id="stats-last-move">-</div>
            </div>
            <div class="esc-card">
                <i class="fa fa-chart-line esc-card-icon"></i>
                <div class="esc-card-header">Avg File Size</div>
                <div class="esc-card-value" id="stats-avg-size">-</div>
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px;">
            <div class="esc-section">
                <div class="esc-section-title"><i class="fa fa-chart-bar"></i> Activity Last 7 Days</div>
                <div style="height:200px; position:relative;">
                    <canvas id="chart-activity"></canvas>
                </div>
            </div>
            <div class="esc-section">
                <div class="esc-section-title"><i class="fa fa-database"></i> Storage Used Last 7 Days</div>
                <div style="height:200px; position:relative;">
                    <canvas id="chart-storage"></canvas>
                </div>
            </div>
        </div>

        <div class="esc-section" style="margin-top:20px;">
            <div class="esc-section-title"><i class="fa fa-list"></i> Top 10 Most Cached Files</div>
            <table class="esc-table" id="stats-top-files">
                <thead>
                    <tr>
                        <th>Filename</th>
                        <th>Times Cached</th>
                        <th>Total Size</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="3" style="text-align:center;color:#888;">Loading statistics...</td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="esc-toolbar" style="margin-top:20px;">
            <button class="esc-btn esc-btn-danger" onclick="resetStatistics()"><i class="fa fa-trash"></i> Reset Statistics</button>
            <span style="color:#888;font-size:12px;margin-left:10px;">Clear all activity history and reset counters</span>
        </div>
    </div>

    <!-- MANAGED FILES PANEL -->
    <div class="esc-panel" id="panel-files">
        <div class="esc-section">
            <div class="esc-section-title"><i class="fa fa-folder-open"></i> Files Currently on Cache</div>
            <table class="esc-table" id="managed-table">
                <thead>
                    <tr>
                        <th>Filename</th>
                        <th>Size</th>
                        <th>Cached At</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="managed-tbody">
                    <tr><td colspan="5" style="text-align:center;color:#888;">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="esc-section">
            <div class="esc-section-title"><i class="fa fa-ban"></i> Mover Ignore List</div>
            <pre id="mover-content" style="background:#111;color:#ccc;padding:15px;border-radius:8px;max-height:200px;overflow-y:auto;font-size:12px;">Loading...</pre>
        </div>
    </div>

    <!-- CLEANUP QUEUE PANEL -->
    <div class="esc-panel" id="panel-queue">
        <div class="esc-section">
            <div class="esc-section-title"><i class="fa fa-clock"></i> Scheduled Cleanup Queue</div>
            <table class="esc-table" id="queue-table">
                <thead>
                    <tr>
                        <th>Filename</th>
                        <th>Scheduled For</th>
                        <th>Time Remaining</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="queue-tbody">
                    <tr><td colspan="4" style="text-align:center;color:#888;">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- LOGS PANEL -->
    <div class="esc-panel" id="panel-logs">
        <div class="esc-toolbar">
            <button class="esc-btn esc-btn-danger" onclick="clearLog()"><i class="fa fa-trash"></i> Clear Log</button>
            <button class="esc-btn esc-btn-primary" id="refresh-logs-btn" onclick="refreshLogs(true)"><i class="fa fa-sync" id="refresh-logs-icon"></i> <span id="refresh-logs-text">Refresh</span></button>
        </div>
        <div class="esc-log-box" id="log-content">Loading...</div>
    </div>

    <!-- SETTINGS PANEL -->
    <div class="esc-panel" id="panel-settings">
        <form id="settings-form">
            <div class="esc-section">
                <div class="esc-section-title"><i class="fa fa-server"></i> Main Settings</div>
                <div class="esc-form-group">
                    <label>Enable Service</label>
                    <select name="ENABLED">
                        <option value="true" <?php echo $settings['ENABLED'] ? 'selected' : ''; ?>>Yes</option>
                        <option value="false" <?php echo !$settings['ENABLED'] ? 'selected' : ''; ?>>No</option>
                    </select>
                </div>
                <div class="esc-form-group">
                    <label>Emby Server URL</label>
                    <input type="text" name="EMBY_HOST" value="<?php echo htmlspecialchars($settings['EMBY_HOST']); ?>">
                </div>
                <div class="esc-form-group">
                    <label>Emby API Key</label>
                    <input type="text" name="EMBY_API_KEY" value="<?php echo htmlspecialchars($settings['EMBY_API_KEY']); ?>">
                </div>
                <div class="esc-form-group">
                    <label>Discord Webhook URL</label>
                    <input type="text" name="DISCORD_WEBHOOK_URL" value="<?php echo htmlspecialchars($settings['DISCORD_WEBHOOK_URL']); ?>" style="width:500px;">
                </div>
                <div class="esc-form-group">
                    <label>Local Webhook Port</label>
                    <input type="number" name="SERVER_PORT" value="<?php echo $settings['SERVER_PORT']; ?>" style="width:100px;">
                </div>
            </div>

            <div class="esc-section">
                <div class="esc-section-title"><i class="fa fa-sliders-h"></i> Performance & Logic</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                    <div class="esc-form-group">
                        <label>Movie Cooldown (sec)</label>
                        <input type="number" name="COOLDOWN_MOVIE_SEC" value="<?php echo $settings['COOLDOWN_MOVIE_SEC']; ?>" style="width:100px;">
                        <div class="help">Wait time before caching a movie</div>
                    </div>
                    <div class="esc-form-group">
                        <label>Episode Cooldown (sec)</label>
                        <input type="number" name="COOLDOWN_EPISODE_SEC" value="<?php echo $settings['COOLDOWN_EPISODE_SEC']; ?>" style="width:100px;">
                        <div class="help">Wait time before caching an episode</div>
                    </div>
                    <div class="esc-form-group">
                        <label>Pre-cache Next Episodes</label>
                        <input type="number" name="PRECACHE_EPISODES" value="<?php echo $settings['PRECACHE_EPISODES'] ?? 1; ?>" style="width:100px;" min="0" max="5">
                        <div class="help">How many next episodes to pre-cache (0=disabled)</div>
                    </div>
                    <div class="esc-form-group">
                        <label>Rsync Retries</label>
                        <input type="number" name="RSYNC_RETRIES" value="<?php echo $settings['RSYNC_RETRIES'] ?? 3; ?>" style="width:100px;" min="1" max="10">
                        <div class="help">Retry count on copy failure</div>
                    </div>
                    <div class="esc-form-group">
                        <label>Rsync Speed Limit (KBps)</label>
                        <input type="number" name="RSYNC_BWLIMIT" value="<?php echo $settings['RSYNC_BWLIMIT']; ?>" style="width:120px;">
                    </div>
                    <div class="esc-form-group">
                        <label>Min Free Space (GB)</label>
                        <input type="number" name="MIN_FREE_SPACE_GB" value="<?php echo $settings['MIN_FREE_SPACE_GB']; ?>" style="width:100px;">
                    </div>
                    <div class="esc-form-group">
                        <label>Max File Size (GB, 0=unlimited)</label>
                        <input type="number" step="0.1" name="MAX_FILE_SIZE_GB" value="<?php echo $settings['MAX_FILE_SIZE_GB']; ?>" style="width:100px;">
                    </div>
                    <div class="esc-form-group">
                        <label>Cleanup Delay (Hours)</label>
                        <input type="number" step="0.5" name="CLEANUP_DELAY_HOURS" value="<?php echo $settings['CLEANUP_DELAY_HOURS']; ?>" style="width:100px;">
                    </div>
                    <div class="esc-form-group">
                        <label>Cleanup Strategy</label>
                        <select name="DELETE_ON_STOP">
                            <option value="true" <?php echo $settings['DELETE_ON_STOP'] ? 'selected' : ''; ?>>Delete & Restore Original</option>
                            <option value="false" <?php echo !$settings['DELETE_ON_STOP'] ? 'selected' : ''; ?>>Keep on Cache</option>
                        </select>
                    </div>
                    <div class="esc-form-group">
                        <label>Hardlink Safety</label>
                        <select name="SKIP_HARDLINKS">
                            <option value="true" <?php echo $settings['SKIP_HARDLINKS'] ? 'selected' : ''; ?>>Skip Hardlinked Files (Safe)</option>
                            <option value="false" <?php echo !$settings['SKIP_HARDLINKS'] ? 'selected' : ''; ?>>Cache Anyway (Fast)</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="esc-section">
                <div class="esc-section-title"><i class="fa fa-folder"></i> Paths & Mappings</div>
                <div class="esc-form-group">
                    <label>User Share Path</label>
                    <input type="text" name="UNRAID_USER_PATH" value="<?php echo htmlspecialchars($settings['UNRAID_USER_PATH']); ?>" style="width:400px;">
                </div>
                <div class="esc-form-group">
                    <label>Cache Pool Path</label>
                    <input type="text" name="CACHE_PATH" value="<?php echo htmlspecialchars($settings['CACHE_PATH']); ?>" style="width:400px;">
                </div>
                <div class="esc-form-group">
                    <label>Array Only Path</label>
                    <input type="text" name="ARRAY_ONLY_PATH" value="<?php echo htmlspecialchars($settings['ARRAY_ONLY_PATH']); ?>" style="width:400px;">
                </div>
                <div class="esc-form-group">
                    <label>Log File Path</label>
                    <input type="text" name="LOG_FILE_PATH" value="<?php echo htmlspecialchars($settings['LOG_FILE_PATH']); ?>" style="width:500px;">
                </div>
                <div class="esc-form-group">
                    <label>Mover Ignore File</label>
                    <input type="text" name="MOVER_IGNORE_FILE" value="<?php echo htmlspecialchars($settings['MOVER_IGNORE_FILE']); ?>" style="width:500px;">
                </div>
                <div class="esc-form-group">
                    <label>Docker Path Mappings</label>
                    <input type="text" name="DOCKER_PATH_MAP" value="<?php echo htmlspecialchars($settings['DOCKER_PATH_MAP']); ?>" style="width:500px;">
                    <div class="help">Format: docker_path:host_path (comma separated for multiple)</div>
                </div>
                <div class="esc-form-group">
                    <label>Allowed Extensions</label>
                    <input type="text" name="ALLOWED_EXTS" value="<?php echo htmlspecialchars($settings['ALLOWED_EXTS']); ?>" style="width:400px;">
                </div>
                <div class="esc-form-group">
                    <label>Exclude Paths (comma separated)</label>
                    <input type="text" name="EXCLUDE_PATHS" value="<?php echo htmlspecialchars($settings['EXCLUDE_PATHS']); ?>" style="width:500px;">
                </div>
                <div class="esc-form-group">
                    <label>Log Retention (files)</label>
                    <input type="number" name="LOG_RETENTION" value="<?php echo $settings['LOG_RETENTION']; ?>" style="width:80px;">
                </div>
                <div class="esc-form-group">
                    <label>Log Level</label>
                    <select name="LOG_LEVEL" style="width:120px;">
                        <option value="DEBUG" <?php echo $settings['LOG_LEVEL'] === 'DEBUG' ? 'selected' : ''; ?>>DEBUG</option>
                        <option value="INFO" <?php echo $settings['LOG_LEVEL'] === 'INFO' ? 'selected' : ''; ?>>INFO</option>
                        <option value="WARNING" <?php echo $settings['LOG_LEVEL'] === 'WARNING' ? 'selected' : ''; ?>>WARNING</option>
                        <option value="ERROR" <?php echo $settings['LOG_LEVEL'] === 'ERROR' ? 'selected' : ''; ?>>ERROR</option>
                    </select>
                    <span style="color:#888;font-size:12px;margin-left:10px;">DEBUG shows most detail</span>
                </div>
            </div>

            <div style="text-align:center;margin-top:20px;">
                <button type="submit" class="esc-btn esc-btn-primary" id="save-btn" style="padding:12px 30px;font-size:15px;">
                    <i class="fa fa-save" id="save-icon"></i> <span id="save-text">Save Settings &amp; Restart Service</span>
                </button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
// AJAX endpoint - use separate PHP file to bypass Unraid page template
var escAjaxUrl = '/plugins/atp_emby_smart_cache/include/ajax.php';
var escRefreshTimer = null;
var escCountdown = 3;
var escCurrentTab = 'dashboard';

$(function() {
    $('.esc-tab').click(function() {
        var tab = $(this).data('tab');
        $('.esc-tab').removeClass('active');
        $(this).addClass('active');
        $('.esc-panel').removeClass('active');
        $('#panel-' + tab).addClass('active');
        escCurrentTab = tab;
        escRefreshData();
    });

    $('#settings-form').submit(function(e) {
        e.preventDefault();
        var $btn = $('#save-btn');
        var $icon = $('#save-icon');
        var $text = $('#save-text');
        
        // Disable and show saving state
        $btn.prop('disabled', true);
        $icon.removeClass('fa-save').addClass('fa-spinner fa-spin');
        $text.text('Saving...');
        
        var fd = $(this).serialize() + '&ajax=save_settings';
        $.post(escAjaxUrl, fd, function(r) {
            if (r && r.success) {
                $icon.removeClass('fa-spinner fa-spin').addClass('fa-check');
                $text.text('Saved!');
                if (typeof swal !== 'undefined') {
                    swal({title:'Saved!', text:r.message || 'Settings saved', type:'success'});
                } else {
                    alert('Settings saved successfully!');
                }
            } else {
                $icon.removeClass('fa-spinner fa-spin').addClass('fa-times');
                $text.text('Error!');
                if (typeof swal !== 'undefined') {
                    swal({title:'Error', text:(r && r.error) || 'Failed to save', type:'error'});
                } else {
                    alert('Error: ' + ((r && r.error) || 'Failed to save'));
                }
            }
            setTimeout(function() {
                $btn.prop('disabled', false);
                $icon.removeClass('fa-check fa-times').addClass('fa-save');
                $text.text('Save Settings & Restart Service');
            }, 2000);
        }, 'json').fail(function(xhr, status, error) {
            $icon.removeClass('fa-spinner fa-spin').addClass('fa-times');
            $text.text('Error!');
            if (typeof swal !== 'undefined') {
                swal({title:'Error', text:'Request failed: ' + error, type:'error'});
            } else {
                alert('Request failed: ' + error);
            }
            setTimeout(function() {
                $btn.prop('disabled', false);
                $icon.removeClass('fa-times').addClass('fa-save');
                $text.text('Save Settings & Restart Service');
            }, 2000);
        });
    });

    escStartRefresh();
});

function escStartRefresh() {
    escRefreshData();
    escRefreshTimer = setInterval(function() {
        escCountdown--;
        $('#refresh-countdown').text(escCountdown);
        if (escCountdown == 0) {
            escCountdown = 3;
            escRefreshData();
        }
    }, 1000);
}

function escRefreshData() {
    if (escCurrentTab === 'dashboard') {
        escRefreshDashboard();
        escRefreshHealth();
    } else if (escCurrentTab === 'stats') {
        escRefreshStats();
    } else if (escCurrentTab === 'files') {
        escRefreshManaged();
        escRefreshMover();
    } else if (escCurrentTab === 'queue') {
        escRefreshQueue();
    }
    // Note: Logs tab does NOT auto-refresh (allows text selection)
    // User must click Refresh button manually
}

function escRefreshDashboard() {
    $.post(escAjaxUrl, {ajax: 'get_status'}, function(d) {
        if (d && d.success) {
            var s = d.data || d;
            // Check for API error (service running but not responding)
            if (s.api_error) {
                $('#dash-service').html('<span class="warning">API Offline</span>');
                $('#dash-uptime').text('-');
                $('#active-transfers').html('<p style="color:#ff9800;">' + escEscape(s.api_error) + '</p>');
            } else {
                $('#dash-service').html(s.running ? '<span class="success">Running</span>' : '<span class="danger">Stopped</span>');
                $('#dash-uptime').text(escFormatUptime(s.uptime || 0));
                $('#dash-active').text(s.active_count || 0);
                $('#dash-queue').text(s.queue_count || 0);
                $('#dash-managed').text(s.managed_count || 0);
                $('#dash-total').text((s.total_gb || 0).toFixed(1) + ' GB');
                
                var at = s.active || [];
                if (at.length === 0) {
                    $('#active-transfers').html('<p style="color:#888;">No active transfers</p>');
                } else {
                    var h = '';
                    for (var i = 0; i < at.length; i++) {
                        h += '<div class="esc-activity-item"><div class="esc-activity-icon copy"><i class="fa fa-sync fa-spin"></i></div><div>' + escEscape(at[i]) + '</div></div>';
                    }
                    $('#active-transfers').html(h);
                }
            }
        } else {
            $('#dash-service').html('<span class="danger">Offline</span>');
            $('#dash-uptime').text('-');
            $('#active-transfers').html('<p style="color:#f44336;">Service not responding</p>');
        }
    }, 'json').fail(function() {
        $('#dash-service').html('<span class="danger">Error</span>');
        $('#dash-uptime').text('-');
        $('#active-transfers').html('<p style="color:#f44336;">Connection failed</p>');
    });
    
    $.post(escAjaxUrl, {ajax: 'get_history'}, function(d) {
        if (d && d.success && d.data && d.data.length) {
            var h = '';
            for (var i = 0; i < Math.min(d.data.length, 10); i++) {
                var e = d.data[i];
                var ic = e.action === 'copy' ? 'copy' : (e.action === 'cleanup' ? 'cleanup' : 'error');
                var fa = e.action === 'copy' ? 'fa-copy' : (e.action === 'cleanup' ? 'fa-trash' : 'fa-exclamation');
                h += '<div class="esc-activity-item">';
                h += '<div class="esc-activity-icon ' + ic + '"><i class="fa ' + fa + '"></i></div>';
                h += '<div><strong>' + escEscape(e.filename) + '</strong><br><small style="color:#888;">' + escEscape(e.timestamp) + '</small></div>';
                h += '</div>';
            }
            $('#recent-activity').html(h);
        } else {
            $('#recent-activity').html('<p style="color:#888;">No recent activity</p>');
        }
    }, 'json').fail(function() {
        $('#recent-activity').html('<p style="color:#888;">No recent activity</p>');
    });
}

function escRefreshHealth() {
    $.post(escAjaxUrl, {ajax: 'get_health'}, function(d) {
        if (d && d.success && d.data) {
            var h = d.data;
            // Cache disk
            var cachePct = h.cache_used_pct || 0;
            $('#health-cache-bar').css('width', cachePct + '%').removeClass('warning danger');
            if (cachePct > 90) $('#health-cache-bar').addClass('danger');
            else if (cachePct > 75) $('#health-cache-bar').addClass('warning');
            $('#health-cache-text').text((h.cache_used_gb || 0).toFixed(1) + ' / ' + (h.cache_total_gb || 0).toFixed(0) + ' GB (' + cachePct.toFixed(0) + '%)');
            
            // Array disk
            var arrayPct = h.array_used_pct || 0;
            $('#health-array-bar').css('width', arrayPct + '%').removeClass('warning danger');
            if (arrayPct > 90) $('#health-array-bar').addClass('danger');
            else if (arrayPct > 75) $('#health-array-bar').addClass('warning');
            $('#health-array-text').text((h.array_used_gb || 0).toFixed(1) + ' / ' + (h.array_total_gb || 0).toFixed(0) + ' GB (' + arrayPct.toFixed(0) + '%)');
            
            // DB and Log size
            $('#health-db-size').text(h.db_size || '-');
            $('#health-log-size').text(h.log_size || '-');
        }
    }, 'json');
}

var escChartActivity = null;
var escChartStorage = null;

function escRefreshStats() {
    $.post(escAjaxUrl, {ajax: 'get_stats'}, function(d) {
        if (d && d.success && d.data) {
            var s = d.data;
            $('#stats-total-moves').text(s.total_moves || 0);
            $('#stats-total-gb').text((s.total_gb || 0).toFixed(1) + ' GB');
            $('#stats-last-move').text(s.last_move || '-');
            $('#stats-avg-size').text((s.avg_size_gb || 0).toFixed(2) + ' GB');
            
            // Update charts
            if (s.daily_activity) {
                escUpdateActivityChart(s.daily_activity);
            }
            if (s.daily_storage) {
                escUpdateStorageChart(s.daily_storage);
            }
            
            // Top files table
            if (s.top_files && s.top_files.length > 0) {
                var h = '';
                for (var i = 0; i < s.top_files.length; i++) {
                    var f = s.top_files[i];
                    h += '<tr><td class="filename">' + escEscape(f.filename) + '</td>';
                    h += '<td>' + f.count + '</td>';
                    h += '<td>' + (f.total_gb || 0).toFixed(2) + ' GB</td></tr>';
                }
                $('#stats-top-files tbody').html(h);
            } else {
                $('#stats-top-files tbody').html('<tr><td colspan="3" style="text-align:center;color:#888;">No data yet</td></tr>');
            }
        }
    }, 'json');
}

function escUpdateActivityChart(data) {
    var ctx = document.getElementById('chart-activity');
    if (!ctx) return;
    
    var labels = data.map(function(d) { return d.date; });
    var copies = data.map(function(d) { return d.copies || 0; });
    var cleanups = data.map(function(d) { return d.cleanups || 0; });
    
    if (escChartActivity) {
        escChartActivity.data.labels = labels;
        escChartActivity.data.datasets[0].data = copies;
        escChartActivity.data.datasets[1].data = cleanups;
        escChartActivity.update();
    } else if (typeof Chart !== 'undefined') {
        escChartActivity = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Copies', data: copies, backgroundColor: '#4caf50' },
                    { label: 'Cleanups', data: cleanups, backgroundColor: '#ff9800' }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                plugins: { legend: { labels: { color: '#aaa' } } }
            }
        });
    }
}

function escUpdateStorageChart(data) {
    var ctx = document.getElementById('chart-storage');
    if (!ctx) return;
    
    var labels = data.map(function(d) { return d.date; });
    var values = data.map(function(d) { return d.gb || 0; });
    
    if (escChartStorage) {
        escChartStorage.data.labels = labels;
        escChartStorage.data.datasets[0].data = values;
        escChartStorage.update();
    } else if (typeof Chart !== 'undefined') {
        escChartStorage = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{ label: 'GB Cached', data: values, borderColor: '#ff9800', backgroundColor: 'rgba(255,152,0,0.1)', fill: true }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } },
                plugins: { legend: { labels: { color: '#aaa' } } }
            }
        });
    }
}

function escRefreshManaged() {
    $.post(escAjaxUrl, {ajax: 'get_managed'}, function(d) {
        if (d && d.success && d.data && d.data.length) {
            var h = '';
            for (var i = 0; i < d.data.length; i++) {
                var f = d.data[i];
                h += '<tr>';
                h += '<td class="filename" title="' + escEscape(f.path) + '">' + escEscape(f.filename) + '</td>';
                h += '<td>' + (f.size_gb || 0).toFixed(2) + ' GB</td>';
                h += '<td>' + escEscape(f.cached_at || '-') + '</td>';
                h += '<td>' + (f.cleanup_at ? '<span class="esc-countdown">Cleanup scheduled</span>' : '<span style="color:#4caf50;">Active</span>') + '</td>';
                h += '<td><button class="esc-btn esc-btn-danger esc-btn-small" onclick="forceCleanup(\'' + escEscape(f.path).replace(/'/g, "\\'") + '\')">Cleanup</button></td>';
                h += '</tr>';
            }
            $('#managed-tbody').html(h);
        } else {
            $('#managed-tbody').html('<tr><td colspan="5" style="text-align:center;color:#888;">No managed files</td></tr>');
        }
    }, 'json').fail(function() {
        $('#managed-tbody').html('<tr><td colspan="5" style="text-align:center;color:#888;">No managed files</td></tr>');
    });
}

function escRefreshMover() {
    $.post(escAjaxUrl, {ajax: 'get_mover'}, function(d) {
        if (d && d.success) {
            $('#mover-content').text(d.content || '(empty)');
        } else {
            $('#mover-content').text('(empty)');
        }
    }, 'json').fail(function() {
        $('#mover-content').text('(unable to load)');
    });
}

function escRefreshQueue() {
    $.post(escAjaxUrl, {ajax: 'get_queue'}, function(d) {
        if (d && d.success && d.data && d.data.length) {
            var h = '';
            var now = Date.now() / 1000;
            for (var i = 0; i < d.data.length; i++) {
                var q = d.data[i];
                var remaining = Math.max(0, (q.cleanup_time || 0) - now);
                h += '<tr>';
                h += '<td class="filename">' + escEscape(q.filename) + '</td>';
                h += '<td>' + new Date((q.cleanup_time || 0) * 1000).toLocaleString() + '</td>';
                h += '<td class="esc-countdown">' + escFormatCountdown(remaining) + '</td>';
                h += '<td><button class="esc-btn esc-btn-danger esc-btn-small" onclick="forceCleanup(\'' + escEscape(q.path).replace(/'/g, "\\'") + '\')">Clean Now</button></td>';
                h += '</tr>';
            }
            $('#queue-tbody').html(h);
        } else {
            $('#queue-tbody').html('<tr><td colspan="4" style="text-align:center;color:#888;">No files in cleanup queue</td></tr>');
        }
    }, 'json').fail(function() {
        $('#queue-tbody').html('<tr><td colspan="4" style="text-align:center;color:#888;">No files in cleanup queue</td></tr>');
    });
}

function refreshLogs(showFeedback) {
    var $btn = $('#refresh-logs-btn');
    var $icon = $('#refresh-logs-icon');
    var $text = $('#refresh-logs-text');
    
    // Only show visual feedback if manually clicked
    if (showFeedback) {
        $btn.prop('disabled', true);
        $icon.removeClass('fa-sync').addClass('fa-spinner fa-spin');
        $text.text('Loading...');
    }
    
    $.post(escAjaxUrl, {ajax: 'get_logs', lines: 100}, function(d) {
        if (d && d.success) {
            $('#log-content').text(d.logs || 'No logs yet');
            var box = document.getElementById('log-content');
            box.scrollTop = box.scrollHeight;
            if (showFeedback) {
                $icon.removeClass('fa-spinner fa-spin').addClass('fa-check');
                $text.text('Updated!');
            }
        } else {
            $('#log-content').text('Unable to load logs');
            if (showFeedback) {
                $icon.removeClass('fa-spinner fa-spin').addClass('fa-times');
                $text.text('Error');
            }
        }
    }, 'json').fail(function() {
        $('#log-content').text('Failed to load logs - service may be offline');
        if (showFeedback) {
            $icon.removeClass('fa-spinner fa-spin').addClass('fa-times');
            $text.text('Error');
        }
    }).always(function() {
        if (showFeedback) {
            setTimeout(function() {
                $btn.prop('disabled', false);
                $icon.removeClass('fa-check fa-times').addClass('fa-sync');
                $text.text('Refresh');
            }, 1500);
        }
    });
}

function clearLog() {
    swal({
        title: 'Clear Log?',
        text: 'This will delete all log entries.',
        type: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#f44336'
    }, function(confirmed) {
        if (confirmed) {
            $.post(escAjaxUrl, {ajax: 'clear_log'}, function(d) {
                swal({title: 'Done', text: d.message, type: 'success'});
                refreshLogs();
            }, 'json');
        }
    });
}

function forceCleanup(path) {
    swal({
        title: 'Force Cleanup?',
        text: 'This will delete the cache copy and restore the original file. This may take a moment for large files.',
        type: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#f44336'
    }, function(confirmed) {
        if (confirmed) {
            // Show loading indicator
            swal({title: 'Processing...', text: 'Please wait while cleanup is in progress...', type: 'info', showConfirmButton: false});
            
            $.ajax({
                url: escAjaxUrl,
                method: 'POST',
                data: {ajax: 'force_cleanup', path: path},
                dataType: 'json',
                timeout: 120000  // 2 minute timeout for large files
            }).done(function(d) {
                swal({title: d.success ? 'Done' : 'Error', text: d.message || d.error || 'Cleanup executed', type: d.success ? 'success' : 'error'});
                escRefreshData();
            }).fail(function(xhr, status, error) {
                var msg = 'Request failed: ' + (error || status);
                if (xhr.responseText) {
                    msg += '\n\nResponse: ' + xhr.responseText.substring(0, 200);
                }
                swal({title: 'Error', text: msg, type: 'error'});
            });
        }
    });
}

function debugApi() {
    $.post(escAjaxUrl, {ajax: 'debug'}, function(d) {
        if (d && d.debug) {
            var msg = 'AJAX Handler Working!\n\n';
            msg += 'PHP Version: ' + d.debug.php_version + '\n';
            msg += 'curl available: ' + d.debug.curl_available + '\n';
            msg += 'Server IP: ' + d.debug.server_ip + '\n';
            msg += 'Port: ' + d.debug.port + '\n';
            msg += 'API URL: ' + d.debug.api_url + '\n';
            msg += 'Config exists: ' + d.debug.config_exists + '\n\n';
            msg += '--- CURL Test ---\n';
            msg += 'HTTP code: ' + d.debug.curl_http_code + '\n';
            msg += 'Error: ' + (d.debug.curl_error || 'none') + '\n';
            msg += 'Response: ' + (d.debug.curl_response || '(empty)').substring(0, 100);
            if (typeof swal !== 'undefined') {
                swal({title: 'API Debug', text: msg, type: d.debug.curl_http_code == 200 ? 'success' : 'warning'});
            } else {
                alert(msg);
            }
        } else {
            alert('Debug returned: ' + JSON.stringify(d));
        }
    }, 'json').fail(function(xhr) {
        alert('AJAX handler failed!\n\nResponse:\n' + xhr.responseText.substring(0, 400));
    });
}

function rebuildState() {
    swal({
        title: 'Rebuild State?',
        text: 'This will scan for .moved_to_cache files and rebuild the database.',
        type: 'info',
        showCancelButton: true
    }, function(confirmed) {
        if (confirmed) {
            // Show loading indicator
            swal({title: 'Rebuilding...', text: 'Please wait while state is being rebuilt...', type: 'info', showConfirmButton: false});
            
            $.ajax({
                url: escAjaxUrl,
                method: 'POST',
                data: {ajax: 'rebuild_state'},
                dataType: 'json',
                timeout: 60000  // 1 minute timeout
            }).done(function(d) {
                swal({title: d.success ? 'Done' : 'Error', text: d.message || d.error || 'State rebuilt', type: d.success ? 'success' : 'error'});
                escRefreshData();
            }).fail(function(xhr, status, error) {
                var msg = 'Request failed: ' + (error || status);
                if (xhr.responseText) {
                    msg += '\n\nResponse: ' + xhr.responseText.substring(0, 200);
                }
                swal({title: 'Error', text: msg, type: 'error'});
            });
        }
    });
}

function resetStatistics() {
    swal({
        title: 'Reset Statistics?',
        text: 'This will clear ALL activity history and reset counters. This cannot be undone.',
        type: 'warning',
        showCancelButton: true
    }, function(confirmed) {
        if (confirmed) {
            $.ajax({
                url: escAjaxUrl,
                method: 'POST',
                data: {ajax: 'reset_stats'},
                dataType: 'json',
                timeout: 30000
            }).done(function(d) {
                swal({title: d.success ? 'Done' : 'Error', text: d.message || d.error || 'Statistics reset', type: d.success ? 'success' : 'error'});
                escRefreshStats();
            }).fail(function(xhr, status, error) {
                swal({title: 'Error', text: 'Request failed: ' + (error || status), type: 'error'});
            });
        }
    });
}

function escFormatUptime(sec) {
    if (sec === 0 || isNaN(sec)) return '-';
    sec = Math.floor(sec);
    if (sec < 60) return sec + 's';
    if (sec < 3600) return Math.floor(sec / 60) + 'm ' + (sec % 60) + 's';
    if (sec < 86400) return Math.floor(sec / 3600) + 'h ' + Math.floor((sec % 3600) / 60) + 'm';
    return Math.floor(sec / 86400) + 'd ' + Math.floor((sec % 86400) / 3600) + 'h';
}

function escFormatCountdown(sec) {
    if (sec <= 0) return 'Now';
    sec = Math.floor(sec);
    if (sec < 60) return sec + 's';
    if (sec < 3600) return Math.floor(sec / 60) + 'm ' + (sec % 60) + 's';
    return Math.floor(sec / 3600) + 'h ' + Math.floor((sec % 3600) / 60) + 'm';
}

function escEscape(str) {
    if (!str) return '';
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
}
</script>
