<?xml version='1.0' standalone='yes'?>
<!DOCTYPE PLUGIN [
<!ENTITY name      "{{ name }}">
<!ENTITY author    "{{ author }}">
<!ENTITY version   "{{ version }}">
<!ENTITY launch    "{{ launch }}">
<!ENTITY gitURL    "https://raw.githubusercontent.com/gitstabs/unraid-plugins/main">
<!ENTITY pluginURL "&gitURL;/emby_smart_cache/emby_smart_cache.plg">
]>

<PLUGIN name="&name;" author="&author;" version="&version;" launch="&launch;" pluginURL="&pluginURL;" icon="{{ icon }}" min="{{ min_unraid }}" support="{{ support }}">

<CHANGES>
##&version;
{% for change in changes[version] %}
- {{ change }}
{% endfor %}
</CHANGES>

<!-- ============================================ -->
<!-- THE MAIN PAGE FILE                           -->
<!-- ============================================ -->
<FILE Name="/usr/local/emhttp/plugins/&name;/EmbySmartCache.page">
<INLINE>
<![CDATA[
{{ page_content }}
]]>
</INLINE>
</FILE>

<!-- ============================================ -->
<!-- AJAX HANDLER                                 -->
<!-- ============================================ -->
<FILE Name="/usr/local/emhttp/plugins/&name;/include/ajax.php">
<INLINE>
<![CDATA[
{{ ajax_content }}
]]>
</INLINE>
</FILE>

<!-- ============================================ -->
<!-- PYTHON DAEMON                                -->
<!-- ============================================ -->
<FILE Name="/boot/config/plugins/&name;/&name;.py" Mode="0755">
<INLINE>
<![CDATA[
{{ python_content }}
]]>
</INLINE>
</FILE>

<!-- ============================================ -->
<!-- RC CONTROL SCRIPT                           -->
<!-- ============================================ -->
<FILE Name="/usr/local/emhttp/plugins/&name;/rc.&name;" Mode="0755">
<INLINE>
<![CDATA[
{{ rc_content }}
]]>
</INLINE>
</FILE>

<!-- ============================================ -->
<!-- INSTALL SCRIPT                              -->
<!-- ============================================ -->
<FILE Run="/bin/bash" Method="install">
<INLINE>
echo "Installing Emby Smart Cache {{ version }}..."

# Create plugin directories
mkdir -p /usr/local/emhttp/plugins/&name;/include
mkdir -p /boot/config/plugins/&name;
mkdir -p /mnt/user/appdata/emby_smart_cache/logs

# Start the service
/usr/local/emhttp/plugins/&name;/rc.&name; start

echo "Installation complete!"
</INLINE>
</FILE>

<!-- ============================================ -->
<!-- REMOVE SCRIPT                               -->
<!-- ============================================ -->
<FILE Run="/bin/bash" Method="remove">
<INLINE>
echo "Removing Emby Smart Cache..."

# Stop the service
/usr/local/emhttp/plugins/&name;/rc.&name; stop 2>/dev/null

# Remove plugin files (keep config and data)
rm -rf /usr/local/emhttp/plugins/&name;

echo "Removal complete. Config and data preserved in:"
echo "  /boot/config/plugins/&name;/"
echo "  /mnt/user/appdata/emby_smart_cache/"
</INLINE>
</FILE>

</PLUGIN>
